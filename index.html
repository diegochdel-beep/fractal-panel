<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fractal Labs | Panel 3D</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#05080a; --side:#0a1219;
      --neon:#39ff14; --cyan:#00d4ff;
      --text:#e0e6ed; --muted:#8fa0b3;
      --line:rgba(0,212,255,.18);
      --card:rgba(255,255,255,.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      overflow:hidden;
    }
    .wrap{display:flex; height:100vh; border:1px solid rgba(255,255,255,.06); border-radius:14px; overflow:hidden}
    .side{
      width:320px; background:linear-gradient(180deg,#071018,#05080a);
      border-right:1px solid rgba(255,255,255,.06);
      padding:18px 16px; overflow:auto;
    }
    .brand{
      border:1px solid rgba(57,255,20,.18);
      background:radial-gradient(120% 120% at 10% 10%, rgba(57,255,20,.10), transparent 50%),
                 radial-gradient(120% 120% at 90% 10%, rgba(0,212,255,.10), transparent 55%),
                 rgba(255,255,255,.02);
      border-radius:14px; padding:14px 12px; margin-bottom:14px;
      box-shadow:0 0 0 1px rgba(0,0,0,.2) inset;
    }
    .title{
      font-family:Orbitron,system-ui; letter-spacing:.12em;
      color:var(--neon); font-size:18px; text-align:center;
      text-shadow:0 0 18px rgba(57,255,20,.25);
    }
    .sub{font-size:11px; text-align:center; color:rgba(224,230,237,.6); margin-top:6px}
    .block{
      margin:12px 0; padding:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
    }
    h3{
      margin:0 0 10px; font-family:Orbitron,system-ui;
      font-size:11px; letter-spacing:.12em; color:rgba(0,212,255,.95);
    }
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .btn{
      width:100%; padding:10px 10px; border-radius:10px;
      font-family:Orbitron,system-ui; font-size:10px; letter-spacing:.08em;
      cursor:pointer; transition:.18s ease;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.35); color:var(--text);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.neon{border-color:rgba(57,255,20,.55); color:var(--neon)}
    .btn.neon:hover{background:rgba(57,255,20,.12)}
    .btn.cyan{border-color:rgba(0,212,255,.55); color:rgba(0,212,255,.95)}
    .btn.cyan:hover{background:rgba(0,212,255,.10)}
    .btn.mag{border-color:rgba(255,0,255,.55); color:rgba(255,0,255,.95)}
    .btn.mag:hover{background:rgba(255,0,255,.08)}
    .notes{
      width:100%; height:70px; resize:none;
      background:rgba(0,0,0,.45); color:var(--text);
      border:1px solid rgba(0,212,255,.35);
      border-radius:10px; padding:10px; font-size:12px;
      outline:none;
    }
    .log{
      height:120px; overflow:auto; font-size:11px; line-height:1.35;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.35);
      border-radius:12px; padding:10px;
    }
    .pillrow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.35);
      font-size:11px; color:rgba(224,230,237,.75);
      font-family:Orbitron,system-ui;
    }
    .dot{width:8px; height:8px; border-radius:50%; background:#666}
    .dot.ok{background:var(--neon); box-shadow:0 0 12px rgba(57,255,20,.35)}
    .main{flex:1; position:relative; background:#000}
    #canvas3d{position:absolute; inset:0}
    .rxOverlay{
      position:absolute; inset:0; display:none;
      background:rgba(0,0,0,.92);
      z-index:50; align-items:center; justify-content:center;
      padding:18px;
    }
    .rxBox{
      max-width:min(1100px,96vw);
      max-height:88vh;
      border:1px solid rgba(0,212,255,.45);
      border-radius:14px;
      overflow:hidden;
      background:rgba(0,0,0,.35);
      position:relative;
    }
    .rxBox img{display:block; max-width:96vw; max-height:88vh}
    .rxClose{
      position:absolute; top:10px; right:10px;
      border:1px solid rgba(57,255,20,.55);
      color:var(--neon); background:rgba(0,0,0,.55);
      padding:8px 10px; border-radius:10px; cursor:pointer;
      font-family:Orbitron,system-ui; font-size:10px;
    }
    @media (max-width: 900px){
      body{overflow:auto}
      .wrap{flex-direction:column; height:auto; min-height:100vh}
      .side{width:100%}
      .main{height:70vh; min-height:520px}
      #canvas3d{position:relative; height:70vh}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <aside class="side">
      <div class="brand">
        <div class="title">FRACTAL LABS</div>
        <div class="sub">Dental Intelligence Panel — WebGL</div>
        <div class="pillrow">
          <span class="pill"><span class="dot" id="dotWebgl"></span> WEBGL</span>
          <span class="pill"><span class="dot" id="dotMax"></span> MAX</span>
          <span class="pill"><span class="dot" id="dotMan"></span> MAN</span>
          <span class="pill"><span class="dot" id="dotRx"></span> RX</span>
        </div>
      </div>

      <div class="block">
        <h3>1) MODELOS STL</h3>
        <div class="grid2">
          <button class="btn cyan" id="btnMax">MAXILA</button>
          <button class="btn cyan" id="btnMan">MANDÍBULA</button>
        </div>
        <input id="inMax" type="file" accept=".stl" hidden>
        <input id="inMan" type="file" accept=".stl" hidden>

        <button class="btn neon" id="btnSim" style="margin-top:10px">SIMULAR EXPANSIÓN</button>
        <button class="btn" id="btnFit" style="margin-top:8px">ENFOCAR / FIT VIEW</button>
        <button class="btn" id="btnReset" style="margin-top:8px">RESET 3D</button>
      </div>

      <div class="block">
        <h3>2) RX</h3>
        <div class="grid2">
          <button class="btn cyan" id="btnRx">SUBIR RX</button>
          <button class="btn neon" id="btnOpenRx">ABRIR OVERLAY</button>
        </div>
        <input id="inRx" type="file" accept="image/*" hidden>
      </div>

      <div class="block">
        <h3>NOTAS</h3>
        <textarea class="notes" id="notes" placeholder="Notas del caso..."></textarea>
        <button class="btn mag" id="btnSend" style="margin-top:10px">ENVIAR A PRODUCCIÓN</button>
      </div>

      <div class="block">
        <h3>LOG</h3>
        <div class="log" id="log"></div>
      </div>
    </aside>

    <main class="main">
      <div id="canvas3d"></div>

      <div class="rxOverlay" id="rxOverlay">
        <div class="rxBox">
          <button class="rxClose" id="rxClose">CERRAR (ESC)</button>
          <img id="rxImg" alt="RX">
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { STLLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/STLLoader.js";

    const $ = (id) => document.getElementById(id);

    const logBox = $("log");
    function log(msg, color="rgba(224,230,237,.8)"){
      const d = document.createElement("div");
      d.textContent = msg;
      d.style.color = color;
      logBox.appendChild(d);
      logBox.scrollTop = logBox.scrollHeight;
    }

    const dotWebgl = $("dotWebgl");
    const dotMax = $("dotMax");
    const dotMan = $("dotMan");
    const dotRx  = $("dotRx");

    // ====== THREE SETUP ======
    const host = $("canvas3d");
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x05080a);

    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 5000);
    camera.position.set(0, 140, 260);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.shadowMap.enabled = false;

    host.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.target.set(0, 40, 0);

    // Lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.9));
    const key = new THREE.DirectionalLight(0xffffff, 0.9);
    key.position.set(200, 300, 200);
    scene.add(key);

    // Helpers
    const grid = new THREE.GridHelper(400, 20, 0x00d4ff, 0x0b1a22);
    grid.material.opacity = 0.22;
    grid.material.transparent = true;
    scene.add(grid);

    const loader = new STLLoader();
    let maxMesh = null, manMesh = null;

    function setDot(el, ok){
      el.className = "dot" + (ok ? " ok" : "");
    }

    function resize(){
      const w = host.clientWidth;
      const h = host.clientHeight;
      if (!w || !h) return;
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    const ro = new ResizeObserver(resize);
    ro.observe(host);
    window.addEventListener("resize", resize);

    function centerAndFit(){
      const box = new THREE.Box3();
      let any = false;
      if (maxMesh){ box.expandByObject(maxMesh); any = true; }
      if (manMesh){ box.expandByObject(manMesh); any = true; }
      if (!any){ log("Nada que enfocar (subí STL).", "rgba(255,255,255,.6)"); return; }

      const size = new THREE.Vector3();
      const center = new THREE.Vector3();
      box.getSize(size);
      box.getCenter(center);

      controls.target.copy(center);

      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * (Math.PI / 180);
      let dist = maxDim / (2 * Math.tan(fov / 2));
      dist *= 1.35;

      camera.position.set(center.x, center.y + dist * 0.35, center.z + dist);
      camera.near = Math.max(0.1, dist / 200);
      camera.far = dist * 20;
      camera.updateProjectionMatrix();

      log("Vista enfocada / Fit view.", "rgba(0,212,255,.95)");
    }

    function clearMesh(mesh){
      if (!mesh) return;
      scene.remove(mesh);
      mesh.geometry?.dispose?.();
      mesh.material?.dispose?.();
    }

    function materialFor(type){
      // max = ligeramente cyan, man = ligeramente verde
      const color = (type === "max") ? 0xeef6ff : 0xf0fff0;
      return new THREE.MeshStandardMaterial({
        color,
        metalness: 0.12,
        roughness: 0.55
      });
    }

    async function loadSTL(file, type){
      if (!file) return;
      const buf = await file.arrayBuffer();
      const geom = loader.parse(buf);
      geom.computeVertexNormals();

      const mesh = new THREE.Mesh(geom, materialFor(type));
      mesh.rotation.x = -Math.PI / 2;

      if (type === "max"){
        clearMesh(maxMesh);
        maxMesh = mesh;
        mesh.position.y = 60;
        setDot(dotMax, true);
      } else {
        clearMesh(manMesh);
        manMesh = mesh;
        mesh.position.y = 10;
        setDot(dotMan, true);
      }

      scene.add(mesh);
      log(`${type.toUpperCase()} cargada: ${file.name}`, "rgba(57,255,20,.95)");
      centerAndFit();
    }

    // ====== UI HOOKS ======
    $("btnMax").onclick = () => $("inMax").click();
    $("btnMan").onclick = () => $("inMan").click();

    $("inMax").addEventListener("change", (e)=> loadSTL(e.target.files?.[0], "max"));
    $("inMan").addEventListener("change", (e)=> loadSTL(e.target.files?.[0], "man"));

    $("btnFit").onclick = centerAndFit;

    $("btnReset").onclick = () => {
      clearMesh(maxMesh); clearMesh(manMesh);
      maxMesh = null; manMesh = null;
      setDot(dotMax, false); setDot(dotMan, false);
      controls.target.set(0,40,0);
      camera.position.set(0,140,260);
      camera.updateProjectionMatrix();
      log("Reset 3D listo.", "rgba(255,255,255,.65)");
    };

    $("btnSim").onclick = () => {
      // demo simple: separar un poco max/mandíbula
      if (!maxMesh && !manMesh){
        log("Subí STL antes de simular.", "rgba(255,120,120,.95)");
        return;
      }
      if (maxMesh) maxMesh.position.x += 2.0;
      if (manMesh) manMesh.position.x -= 2.0;
      log("Simulación demo aplicada (+/- 2mm en X).", "rgba(57,255,20,.95)");
    };

    // RX overlay
    const rxOverlay = $("rxOverlay");
    const rxImg = $("rxImg");

    $("btnRx").onclick = () => $("inRx").click();

    $("inRx").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = () => {
        rxImg.src = r.result;
        setDot(dotRx, true);
        log(`RX lista: ${f.name}`, "rgba(0,212,255,.95)");
      };
      r.readAsDataURL(f);
    });

    $("btnOpenRx").onclick = () => {
      if (!rxImg.src){
        log("Primero subí una RX.", "rgba(255,120,120,.95)");
        return;
      }
      rxOverlay.style.display = "flex";
    };

    $("rxClose").onclick = () => rxOverlay.style.display = "none";
    window.addEventListener("keydown", (ev)=>{
      if (ev.key === "Escape") rxOverlay.style.display = "none";
    });

    $("btnSend").onclick = () => {
      const txt = $("notes").value.trim();
      log("Envío a producción (demo).", "rgba(255,0,255,.95)");
      if (txt) log("Notas: " + txt, "rgba(255,0,255,.75)");
    };

    // ====== WebGL check ======
    try{
      const gl = renderer.getContext();
      if (gl) setDot(dotWebgl, true);
      log("WEBGL OK", "rgba(57,255,20,.95)");
    }catch(err){
      setDot(dotWebgl, false);
      log("WEBGL FALLÓ: " + err?.message, "rgba(255,120,120,.95)");
    }

    // Render loop
    function tick(){
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(tick);
    }
    resize();
    tick();
  </script>
</body>
</html>
