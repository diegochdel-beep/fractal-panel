<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fractal Labs | Panel 3D</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#05080a; --side:#0a1219; --neon:#39ff14; --cyan:#00d4ff;
      --text:#e0e6ed; --muted:#8fa0b3; --line:rgba(0,212,255,.18);
      --card:rgba(255,255,255,.03);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      overflow:hidden;
    }

    .wrap{ height:100vh; display:flex; border:1px solid rgba(0,212,255,.12); border-radius:14px; overflow:hidden; }
    .side{
      width:320px; background:linear-gradient(180deg,var(--side),rgba(0,0,0,.9));
      border-right:1px solid rgba(0,212,255,.12); padding:18px; overflow:auto;
    }
    .brand{ text-align:center; padding:10px 10px 14px; border-bottom:1px solid rgba(0,212,255,.10); margin-bottom:14px; }
    .title{ font-family:Orbitron; color:var(--neon); font-size:20px; letter-spacing:1px; }
    .sub{ color:var(--muted); font-size:11px; margin-top:4px; }

    .card{
      background:var(--card); border:1px solid rgba(0,212,255,.12);
      border-radius:14px; padding:12px; margin:12px 0;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .h3{ font-family:Orbitron; font-size:11px; color:var(--cyan); margin:0 0 10px; letter-spacing:.8px; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    button{
      appearance:none; border-radius:10px; cursor:pointer; user-select:none;
      font-family:Orbitron; font-size:10px; letter-spacing:.7px;
      padding:11px 10px; background:rgba(0,0,0,.35);
      border:1px solid rgba(0,212,255,.22); color:var(--text);
      transition:.18s transform, .18s background, .18s border-color;
    }
    button:hover{ transform:translateY(-1px); border-color:rgba(57,255,20,.55); }
    .neon{ border-color:rgba(57,255,20,.55); color:var(--neon); }
    .neon:hover{ background:rgba(57,255,20,.12); }
    .mag{ border-color:rgba(255,0,255,.5); color:#ff5cff; }
    .mag:hover{ background:rgba(255,0,255,.10); }

    .note{
      width:100%; height:70px; resize:vertical; min-height:70px;
      background:rgba(0,0,0,.55); border:1px solid rgba(0,212,255,.35);
      color:var(--text); border-radius:12px; padding:10px; font-size:12px;
      outline:none;
    }

    .log{
      height:120px; overflow:auto; font-size:11px; color:var(--muted);
      border:1px solid rgba(0,212,255,.12); border-radius:12px; padding:10px;
      background:rgba(0,0,0,.35);
    }
    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      font-size:11px; padding:7px 10px; border-radius:999px;
      border:1px solid rgba(0,212,255,.18); background:rgba(0,0,0,.35);
      color:var(--muted); display:inline-flex; align-items:center; gap:8px;
      font-family:Roboto;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:#888; }
    .ok{ background:var(--neon); }
    .cy{ background:var(--cyan); }

    .main{ flex:1; position:relative; min-width:0; }
    #viewer{ position:absolute; inset:0; }
    .topbar{
      position:absolute; top:10px; left:10px; right:10px; z-index:10;
      display:flex; justify-content:space-between; gap:10px; pointer-events:none;
    }
    .badge{
      pointer-events:none;
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(0,212,255,.14);
      backdrop-filter: blur(8px);
      font-family:Orbitron; font-size:10px; color:var(--muted);
    }
    .badge b{ color:var(--text); font-weight:700; }

    /* RX overlay */
    #rxOv{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.90); z-index:50;
    }
    #rxBox{ position:relative; max-width:92%; max-height:92%; }
    #rxImg{ max-width:100%; max-height:90vh; border:2px solid var(--cyan); border-radius:12px; }
    #rxClose{
      position:absolute; top:-38px; right:0;
      background:transparent; border:0; color:var(--neon);
      font-family:Orbitron; font-size:11px; cursor:pointer;
      padding:6px 10px;
    }

    @media (max-width: 900px){
      body{ overflow:auto; }
      .wrap{ height:auto; min-height:100vh; flex-direction:column; border-radius:0; }
      .side{ width:100%; }
      .main{ height:70vh; }
      #viewer{ position:relative; height:70vh; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <aside class="side">
      <div class="brand">
        <div class="title">FRACTAL LABS</div>
        <div class="sub">Dental Intelligence Panel — WebGL</div>
      </div>

      <div class="card">
        <div class="pillrow">
          <span class="pill"><span class="dot ok" id="dotWebgl"></span> WEBGL</span>
          <span class="pill"><span class="dot" id="dotMax"></span> MAX</span>
          <span class="pill"><span class="dot" id="dotMan"></span> MAN</span>
          <span class="pill"><span class="dot" id="dotRx"></span> RX</span>
        </div>
      </div>

      <div class="card">
        <div class="h3">1) MODELOS STL</div>
        <div class="grid2">
          <button id="btnMax">MAXILA</button>
          <button id="btnMan">MANDÍBULA</button>
        </div>
        <button class="neon" id="btnSim" style="margin-top:10px;">SIMULAR EXPANSIÓN</button>
        <button id="btnFit" style="margin-top:8px;">ENFOCAR / FIT VIEW</button>
        <button id="btnReset" style="margin-top:8px;">RESET 3D</button>

        <input id="inMax" type="file" accept=".stl" hidden />
        <input id="inMan" type="file" accept=".stl" hidden />
      </div>

      <div class="card">
        <div class="h3">2) RX</div>
        <div class="grid2">
          <button id="btnRx">SUBIR RX</button>
          <button class="neon" id="btnRxOpen">ABRIR OVERLAY</button>
        </div>
        <input id="inRx" type="file" accept="image/*" hidden />
      </div>

      <div class="card">
        <div class="h3">NOTAS</div>
        <textarea class="note" id="notes" placeholder="Notas del caso..."></textarea>
        <button class="mag" id="btnSend" style="margin-top:10px;">ENVIAR A PRODUCCIÓN</button>
      </div>

      <div class="card">
        <div class="h3">LOG</div>
        <div class="log" id="log"></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="badge"><b>3D PANEL</b> • rotar/zoom con mouse • pan: shift</div>
        <div class="badge">Fractal Labs</div>
      </div>
      <div id="viewer"></div>

      <div id="rxOv">
        <div id="rxBox">
          <img id="rxImg" alt="RX" />
          <button id="rxClose">CERRAR (ESC)</button>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { STLLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/STLLoader.js";

    const $ = (id) => document.getElementById(id);

    const logEl = $("log");
    const log = (msg, color="#8fa0b3") => {
      const d = document.createElement("div");
      d.textContent = msg;
      d.style.color = color;
      logEl.appendChild(d);
      logEl.scrollTop = logEl.scrollHeight;
    };

    // UI refs
    const dotWebgl = $("dotWebgl");
    const dotMax = $("dotMax");
    const dotMan = $("dotMan");
    const dotRx  = $("dotRx");

    const btnMax = $("btnMax");
    const btnMan = $("btnMan");
    const btnSim = $("btnSim");
    const btnFit = $("btnFit");
    const btnReset = $("btnReset");
    const btnRx = $("btnRx");
    const btnRxOpen = $("btnRxOpen");
    const btnSend = $("btnSend");

    const inMax = $("inMax");
    const inMan = $("inMan");
    const inRx  = $("inRx");

    const rxOv = $("rxOv");
    const rxImg = $("rxImg");
    const rxClose = $("rxClose");

    // Basic sanity
    dotWebgl.classList.add("ok");
    log("WEBGL OK", "#39ff14");

    // Scene
    const container = $("viewer");
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x05080a);

    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 2000);
    camera.position.set(0, 120, 260);

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;

    // Lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.65));
    const key = new THREE.DirectionalLight(0xffffff, 0.9);
    key.position.set(150, 250, 180);
    scene.add(key);
    const rim = new THREE.DirectionalLight(0x00d4ff, 0.35);
    rim.position.set(-200, 120, -180);
    scene.add(rim);

    // Helpers: subtle grid
    const grid = new THREE.GridHelper(500, 20, 0x00d4ff, 0x0a1a22);
    grid.material.opacity = 0.18;
    grid.material.transparent = true;
    scene.add(grid);

    // STL handling
    const stlLoader = new STLLoader();
    let maxMesh = null;
    let manMesh = null;

    const mat = new THREE.MeshStandardMaterial({
      color: 0xeaeaea,
      metalness: 0.1,
      roughness: 0.45
    });

    function disposeMesh(m){
      if(!m) return;
      scene.remove(m);
      m.geometry?.dispose?.();
      if(Array.isArray(m.material)) m.material.forEach(x=>x.dispose?.());
      else m.material?.dispose?.();
    }

    function centerAndPlace(mesh, y){
      mesh.rotation.x = -Math.PI / 2;
      // center geometry
      mesh.geometry.computeBoundingBox();
      const box = mesh.geometry.boundingBox;
      const cx = (box.min.x + box.max.x) / 2;
      const cy = (box.min.y + box.max.y) / 2;
      const cz = (box.min.z + box.max.z) / 2;
      mesh.geometry.translate(-cx, -cy, -cz);
      mesh.position.set(0, y, 0);
      mesh.scale.set(1,1,1);
    }

    function loadSTL(file, which){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try{
          const geo = stlLoader.parse(e.target.result);
          const mesh = new THREE.Mesh(geo, mat.clone());
          centerAndPlace(mesh, which === "max" ? 28 : -28);

          if(which === "max"){
            disposeMesh(maxMesh);
            maxMesh = mesh;
            dotMax.classList.add("ok");
            log("MAX cargada ✅", "#39ff14");
          }else{
            disposeMesh(manMesh);
            manMesh = mesh;
            dotMan.classList.add("ok");
            log("MAN cargada ✅", "#39ff14");
          }
          scene.add(mesh);
          fitView();
        }catch(err){
          console.error(err);
          log("Error leyendo STL: " + err.message, "#ff5c5c");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function fitView(){
      // Fit both meshes if exist
      const objs = [];
      if(maxMesh) objs.push(maxMesh);
      if(manMesh) objs.push(manMesh);
      if(!objs.length){
        log("No hay modelos para enfocar.", "#8fa0b3");
        return;
      }
      const box = new THREE.Box3();
      objs.forEach(o => box.expandByObject(o));

      const size = new THREE.Vector3();
      box.getSize(size);
      const center = new THREE.Vector3();
      box.getCenter(center);

      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * (Math.PI / 180);
      let camZ = Math.abs(maxDim / (2 * Math.tan(fov / 2)));
      camZ *= 1.7;

      camera.position.set(center.x, center.y + maxDim*0.35, center.z + camZ);
      controls.target.copy(center);
      controls.update();

      log("Fit view ✅", "#00d4ff");
    }

    function reset3D(){
      disposeMesh(maxMesh); maxMesh=null; dotMax.classList.remove("ok");
      disposeMesh(manMesh); manMesh=null; dotMan.classList.remove("ok");
      camera.position.set(0, 120, 260);
      controls.target.set(0,0,0);
      controls.update();
      log("Reset 3D ✅", "#00d4ff");
    }

    function simulateExpansion(){
      // Simulación simple (placeholder): separa + escala lateral
      const has = !!(maxMesh || manMesh);
      if(!has){
        log("Sube STL(s) antes de simular.", "#ffb020");
        return;
      }
      const amount = 1.03; // 3% "expansión"
      if(maxMesh){
        maxMesh.scale.x *= amount;
        maxMesh.scale.z *= amount;
        maxMesh.position.y = 32;
      }
      if(manMesh){
        manMesh.scale.x *= amount;
        manMesh.scale.z *= amount;
        manMesh.position.y = -32;
      }
      log("Simulación aplicada (demo) ✅", "#39ff14");
      fitView();
    }

    // RX overlay
    function openRx(){
      if(!rxImg.src){
        alert("Sube una RX primero.");
        return;
      }
      rxOv.style.display = "flex";
      log("Overlay RX abierto", "#00d4ff");
    }
    function closeRx(){
      rxOv.style.display = "none";
    }

    // Wire UI
    btnMax.addEventListener("click", () => inMax.click());
    btnMan.addEventListener("click", () => inMan.click());
    inMax.addEventListener("change", (e) => loadSTL(e.target.files?.[0], "max"));
    inMan.addEventListener("change", (e) => loadSTL(e.target.files?.[0], "man"));

    btnSim.addEventListener("click", simulateExpansion);
    btnFit.addEventListener("click", fitView);
    btnReset.addEventListener("click", reset3D);

    btnRx.addEventListener("click", () => inRx.click());
    inRx.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = (ev) => {
        rxImg.src = ev.target.result;
        dotRx.classList.add("cy");
        log("RX lista ✅", "#00d4ff");
      };
      r.readAsDataURL(file);
    });
    btnRxOpen.addEventListener("click", openRx);
    rxClose.addEventListener("click", closeRx);
    window.addEventListener("keydown", (ev) => { if(ev.key === "Escape") closeRx(); });

    btnSend.addEventListener("click", () => {
      const notes = $("notes").value.trim();
      log("ENVIAR A PRODUCCIÓN (demo) — notas: " + (notes ? notes.slice(0,80) + (notes.length>80?"…":"") : "(vacío)"), "#ff5cff");
      alert("Demo: aquí conectarías tu envío a email/Drive/endpoint.");
    });

    // Resize
    function onResize(){
      const w = container.clientWidth;
      const h = container.clientHeight;
      renderer.setSize(w, h);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    new ResizeObserver(onResize).observe(container);

    // Render loop
    function tick(){
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(tick);
    }
    tick();

    // If something breaks, you see it
    window.addEventListener("error", (e) => {
      log("JS Error: " + e.message, "#ff5c5c");
    });
  </script>
</body>
</html>
